import socket
import sys

def RegistroLogs(mensagem):
    logs = open('logs.txt', 'a')
    logs.write(mensagem)
    logs.close

senha_servidor = '123456'
servidor = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
IP = '0.0.0.0'
porta = int(sys.argv[1])

servidor.bind((IP, porta))
servidor.listen(1)

print(f"Aguardando conexão {IP} {porta}")

conexao, EndCliente = servidor.accept()
print(f"\nConectado com: {EndCliente}\n")

conexao.send("Digite a senha: ".encode())
senha_usuario = conexao.recv(1024)

if senha_usuario.decode() == senha_servidor:
    RegistroLogs(f"{EndCliente} acessou o servidor\n")

    print(f"\n*** Senha correta ***")
    print("Conexão liberada\n")

    conexao.send("\n> *** Senha correta ***\n> Conexão liberada\n".encode())
    
    while True:
        mensagem = input("> ")

        if mensagem == 'sair':
            conexao.send("< Conexão finalizada".encode())
            servidor.close()
            break
    
        mensagem = '\n< ' + mensagem 
        conexao.send(mensagem.encode())

        dados_cliente = conexao.recv(1024)
        RegistroLogs(f"{EndCliente} - {dados_cliente.decode()}")

        if dados_cliente.decode() == '\nConexão encerrada\n':
            RegistroLogs(f"{EndCliente} - Encerrou a conexão")   

            print("\nConexão encerrada\n")
            servidor.close()
            break
        print(f"< {dados_cliente.decode()}")

else:
    RegistroLogs(f"\n{EndCliente} Errou a senha\nConexão finalizada")

    conexao.send("\n> Senha incorreta".encode())
    servidor.close()