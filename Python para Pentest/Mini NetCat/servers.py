import socket
import registrarLogs

class Server:
    def TCP(IP, porta):
        senha_servidor = '123456'
        servidor = socket.socket(socket.AF_INET,socket.SOCK_STREAM)

        logs = registrarLogs.Logs
  
        servidor.bind((IP, porta))
        servidor.listen(1)

        print(f"Aguardando conexão TCP com {IP} {porta}")

        conexao, EndCliente = servidor.accept()
        print(f"\nConectado com: {EndCliente}\n")

        conexao.send("Digite a senha: ".encode())
        senha_usuario = conexao.recv(1024)

        if senha_usuario.decode() == senha_servidor:

            logs.RegistrarLogs(f"{IP} - se conectou\n", 'logsTCP.txt')

            print(f"\n*** Senha correta ***")
            print("Conexão liberada\n")

            conexao.send("\n> *** Senha correta ***\n> Conexão liberada\n".encode())
            
            while True:
                mensagem = input("> ")

                if mensagem == 'sair':

                    logs.RegistrarLogs("conexão encerrada\n", 'logsTCP.txt')

                    conexao.send("< Conexão finalizada".encode())
                    servidor.close()
                    break
            
                mensagem = '\n< ' + mensagem 
                conexao.send(mensagem.encode())

                dados_cliente = conexao.recv(1024)
    
                if dados_cliente.decode() == '\nConexão encerrada\n': 

                    logs.RegistrarLogs(f"{IP} - se desconectou\n", 'logsTCP.txt')

                    print("\nConexão encerrada\n")
                    servidor.close()
                    break

                logs.RegistrarLogs(f"{IP} - {dados_cliente.decode()}", 'logsTCP.txt')

                print(f"< {dados_cliente.decode()}")

        else:

            logs.RegistrarLogs(f"{IP} - senha incorreta\n", 'logsTCP.txt')

            conexao.send("\n> Senha incorreta".encode())
            servidor.close()

    def UDP(IP, porta):
        servidor = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)

        servidor.bind((IP,porta))

        print(f"\nAguandando conexão UDP com {IP}:{porta}\n")
        logs = registrarLogs.Logs

        while True:
            mensagemCliente, EndCliente = servidor.recvfrom(1024)

            if mensagemCliente.decode() == 'sair':

                logs.RegistrarLogs(f"{EndCliente} - Encerrou a conexão\n", 'logsUDP.txt')

                print(f"< {'Finalizando...'} - {EndCliente}\n")
                servidor.close()
                break

            logs.RegistrarLogs(f"{EndCliente} - {mensagemCliente.decode()}\n", 'logsUDP.txt')

            print(f"\n< {mensagemCliente.decode()} - {EndCliente}")

            mensagem = input("> ")

            if mensagem == 'sair':

                logs.RegistrarLogs("Conexão encerrada\n", 'logsUDP.txt')

                servidor.sendto('Finalizando...'.decode(), (EndCliente))
                servidor.close()
                break
            servidor.sendto(mensagem.encode(), (EndCliente))