import socket
import json
import dns.resolver
import time

class Dnsscan:
    def subdomain_bruteforce(dominio, wlist):
        def DNSipv4(dominio_montado):
            try:
                dados = socket.getaddrinfo(dominio_montado, None, socket.AF_INET)
                IP = dados[1][4][0]

                print(f"{dominio_montado}\t\t- {IP}")
                return IP
            except socket.gaierror:
                return 0

        def DNSipv6(dominio_montado):
            try:
                dados = socket.getaddrinfo(dominio_montado, None, socket.AF_INET6)
                IP = dados[1][4][0]

                print(f"{dominio_montado}\t\t- {IP}")

                return IP
            except socket.gaierror:
                return 0

        resolvidos = []
        dominios4 = {}
        dominios6 = {}
        registros_completos = {}

        with open (wlist) as wordlist:

            for i in wordlist.readlines():
                i = i.replace('\n',"")
                dominio_montado = f"{i}.{dominio}"

                if dominio_montado not in resolvidos:

                    IPv4 = DNSipv4(dominio_montado)
                    IPv6 = DNSipv6(dominio_montado)

                    resolvidos.append(dominio_montado)

                    if IPv4 != 0:
                        dominios4[dominio_montado] = IPv4
                    if IPv6 != 0:
                        dominios6[dominio_montado] = IPv6

        registros_completos['IPv4'] = dominios4
        registros_completos['IPv6'] = dominios6

        registros_JSON = json.dumps(registros_completos)

        with open(f"scans/{dominio}/{dominio}-subdomains.json", 'w') as f:
            f.write(registros_JSON)

        print(f"Arquivo {dominio}-subdomains.json criado")

    def cname_bruteforce(dominio, wlist):

        resolvidos = []
        registros = {}

        with open(wlist) as wordlist:

            for i in wordlist.readlines():
                i = i.replace('\n',"")
                    
                subdominio = f"{i}.{dominio}"

                if subdominio not in resolvidos:
                    while True: 
                        resolvidos.append(subdominio) 

                        try:
                            resposta = dns.resolver.resolve(subdominio,"CNAME")
                            cname = str(resposta[0])

                            registros[subdominio] = cname
                            print(f"{subdominio} - Ã© um alias para - {cname} ")
                            break
                        except dns.resolver.NoAnswer:
                            break
                        except dns.resolver.NXDOMAIN:
                            break
                        except dns.resolver.LifetimeTimeout:
                            time.sleep(3)
                        except dns.resolver.NoNameservers:
                            None

            registros_json = json.dumps(registros)
            with open(f"scans/{dominio}/{dominio}-cnames.json", "w") as f:
                f.write(registros_json)

            print(f"Arquivo {dominio}-cnames.json criado")


    def consulta_whois(dominio):
        def Servidor(servidor_whois, dominio_env):
            servidor = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            servidor.connect((servidor_whois, 43))
            servidor.send(dominio_env.encode())
            
            return servidor

        dominio_env = dominio+'\r\n'

        servidor = Servidor("whois.iana.org", dominio_env)
        s_whois_primario = servidor.recv(1024).decode().split("refer:        ")[1].split("\n")[0]
        servidor.close()

        servidor = Servidor(s_whois_primario, dominio_env)
        s_whois_secundario = servidor.recv(1024).decode().split("\n")[2].split(" ")[6]
        s_whois_secundario = s_whois_secundario.replace("\r","")
        servidor.close()

        servidor = Servidor(s_whois_secundario, dominio_env)
        reposta_final = ""
        while True:
            dados = servidor.recv(8024)
            if dados:
                reposta_final+= dados.decode()
            else:
                break


        with open(f"scans/{dominio}/{dominio}-whois.txt", "w") as f:
            f.write(reposta_final)
            f.close()

        print(f"\nArquivo {dominio}-whois.txt gerado\n")
            
