## ğŸ•µï¸ Evitando detecÃ§Ã£o em varreduras de portas

Durante um portscan, algumas tÃ©cnicas podem gerar logs e alertas em sistemas de seguranÃ§a. Por isso, existem mÃ©todos mais discretos, conhecidos como **varreduras furtivas (stealth scans)**.

---

### ğŸ§ª Teste com Netcat

Podemos simular uma porta aberta para testar o comportamento do scanner.

**Abrindo uma porta em modo escuta:**

```
nc -lvp 8080
```

Depois, executamos o portscan:

```
python3 portscan.py localhost portasFiltradas.txt
```

ğŸ“Œ **Resultado observado:**

- A conexÃ£o TCP Ã© **completamente estabelecida**.
- O **3-way handshake (3WHS)** Ã© concluÃ­do.
- Isso gera **logs no sistema** e pode ser detectado.

---

### âš ï¸ Problema do TCP Connect Scan

- Realiza a conexÃ£o completa.
- FÃ¡cil de detectar por:
  - IDS (Intrusion Detection System)
  - IPS (Intrusion Prevention System)

---

### ğŸ•¶ï¸ SoluÃ§Ã£o: SYN Scan (varredura furtiva)

Comando:

```
nmap -sS
```

ğŸ“Œ CaracterÃ­sticas:

- NÃ£o completa o **3WHS**.
- Envia apenas o pacote **SYN**.
- Mais discreto.
- Reduz a geraÃ§Ã£o de logs.

---

## ğŸ Biblioteca Scapy

A **Scapy** permite trabalhar com pacotes em um nÃ­vel mais baixo que o socket.

### ğŸ¯ Vantagens

- ManipulaÃ§Ã£o direta dos pacotes.
- Controle total dos headers.
- Ideal para scans furtivos.

---

### ğŸ“¦ InstalaÃ§Ã£o

Via apt:

```
sudo apt install python3-scapy
```

Via pip:

```
pip install scapy
```

---

### ğŸ“¥ Importando mÃ³dulos

```python
from scapy.all import IP, TCP, sr, L3RawSocket, conf, RandShort
```

#### FunÃ§Ã£o de cada mÃ³dulo

- **IP**: criaÃ§Ã£o de pacotes IP.
- **TCP**: criaÃ§Ã£o de segmentos TCP.
- **sr**: enviar e receber pacotes.
- **L3RawSocket**: trabalhar com pacotes brutos.
- **conf**: configuraÃ§Ãµes de rede.
- **RandShort**: gera porta de origem aleatÃ³ria.

---

## âš™ï¸ ConfiguraÃ§Ã£o inicial

### Definindo alvo

```python
porta = 8080
host = "127.0.0.1"
```

ğŸ“Œ ObservaÃ§Ã£o:

- Scapy aceita **apenas endereÃ§os IP**.
- NÃ£o aceita domÃ­nios.

---

### Configurando o socket

```python
conf.L3socket = L3RawSocket
```

Isso permite trabalhar com **pacotes brutos na camada 3**.

---

## ğŸ“¦ Criando os pacotes

### Pacote IP

```python
pacote_ip = IP(dst=host)
```

- Necessita apenas do endereÃ§o de destino.

---

### Segmento TCP

```python
segmento_tcp = TCP(
    dport=porta,
    sport=RandShort(),
    flags='S',
    seq=1000,
    options=[("MSS", 1460), ("NOP", None), ("WScale", 7)]
)
```

#### ExplicaÃ§Ã£o dos campos

- **dport**: porta de destino.
- **sport**: porta de origem aleatÃ³ria.
- **flags='S'**: flag SYN (inÃ­cio da conexÃ£o).
- **seq**: nÃºmero de sequÃªncia.
- **options**:
  - **MSS (1460)**: tamanho mÃ¡ximo do segmento.
  - **NOP**: alinhamento de dados.
  - **WScale**: escala de janela (0 a 14).

ğŸ“Œ Ethernet padrÃ£o:

- MTU: **1500 bytes**
- 40 bytes: headers IP + TCP
- 1460 bytes: payload

---

## ğŸ“¡ Enviando o pacote

FunÃ§Ã£o:

```python
respostas, semrsp = sr(pacote_ip/segmento_tcp, timeout=1)
```

### Retornos da funÃ§Ã£o

- **respostas**: pacotes que receberam resposta.
- **semrsp**: pacotes sem resposta.

---

### Visualizando pacotes

```python
print(respostas[0][0])  # pacote enviado
print(respostas[0][1])  # pacote recebido
```

---

## ğŸ” Interpretando respostas

### SituaÃ§Ãµes possÃ­veis

#### ğŸ“­ Sem resposta

- Porta pode estar:
  - Filtrada por firewall
  - Protegida por filtro de pacotes

```python
if respostas:
    # houve resposta
else:
    print("porta filtrada")
```

---

#### ğŸŸ¢ Resposta com SYN-ACK

- Porta **aberta**.

#### ğŸ”´ Resposta com RST

- Porta **fechada**.

---

## ğŸ§  Resumo prÃ¡tico

- TCP connect scan gera logs.
- SYN scan Ã© mais discreto.
- Scapy permite criar scans furtivos.
- Respostas indicam:
  - **SYN-ACK** â†’ porta aberta.
  - **RST** â†’ porta fechada.
  - **Sem resposta** â†’ filtrada.

---
